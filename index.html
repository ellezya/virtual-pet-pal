<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#C4A57B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LaLaLola">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Mobile App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="true">
    
    <title>LaLaLola - Virtual Pet</title>
    <meta name="description" content="Care for Lola the bunny - earn time through chores and school rewards" />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="LaLaLola - Virtual Pet" />
    <meta property="og:description" content="Care for Lola the bunny - earn time through chores and school rewards" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/icon-512.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@Lovable" />
    <meta name="twitter:image" content="/icon-512.png" />
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <!-- Service Worker Registration -->
    <script>
      (function () {
        if (!('serviceWorker' in navigator)) return;

        const hostname = window.location.hostname;
        const isPreviewHost =
          hostname.startsWith('id-preview--') ||
          hostname === 'lovableproject.com' ||
          hostname.endsWith('.lovableproject.com');

        // In preview, service workers commonly cause "stuck on old UI" because they cache bundles.
        // So we proactively unregister + clear caches once, then skip SW registration entirely.
        if (isPreviewHost) {
          window.addEventListener('load', async () => {
            const flag = '__lalalola_preview_sw_cleared__';
            if (sessionStorage.getItem(flag) === '1') return;
            sessionStorage.setItem(flag, '1');

            try {
              const regs = await navigator.serviceWorker.getRegistrations();
              await Promise.all(regs.map((r) => r.unregister()));

              if ('caches' in window) {
                const keys = await caches.keys();
                await Promise.all(keys.map((k) => caches.delete(k)));
              }
            } catch (error) {
              console.log('Preview SW cleanup failed:', error);
            } finally {
              // Reload once so the preview immediately pulls the latest files.
              window.location.reload();
            }
          });
          return;
        }

        window.addEventListener('load', async () => {
          try {
            const registration = await navigator.serviceWorker.register('/sw.js');

            // If a new service worker is found, reload once it's installed so users get latest UI.
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (!newWorker) return;

              newWorker.addEventListener('statechange', () => {
                // When there's an existing SW controlling the page, 'installed' means an update.
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  window.location.reload();
                }
              });
            });
          } catch (error) {
            console.log('SW registration failed:', error);
          }
        });
      })();
    </script>
  </body>
</html>
